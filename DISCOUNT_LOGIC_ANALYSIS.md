# CU 할인 계산 로직 분석

엑셀 파일 `CU 할인 계산기_v2.2.xlsx` 분석 결과

## 📋 할인 적용 순서 (중요!)

CU 할인은 **순차적으로 적용**되며, 각 단계마다 이전 단계의 할인 적용된 금액을 기준으로 계산됩니다.

### 할인 적용 순서

```
정가 금액
  ↓ (1) 쿠폰 할인
할인 후 금액 1
  ↓ (2) 통신사 할인
할인 후 금액 2
  ↓ (3) 결제행사 할인
할인 후 금액 3
  ↓ (4) 금액권 차감
할인 후 금액 4
  ↓ (5) 결제 할인(독립형) - 정가 기준
할인 후 금액 5
  ↓ (6) 결제 할인(누적형) - 누적 할인 후 금액 기준
최종 결제 금액
```

## 🎯 6가지 할인 유형

### 1. 쿠폰 할인
- **종류**: 구독 쿠폰, 상품 할인 쿠폰, 선착순 할인 쿠폰
- **적용 방식**: 정가 기준 퍼센트 할인
- **중복**: 상품 1개당 쿠폰 1개, 한 번의 결제에 여러 쿠폰 사용 가능
- **예시**:
  - 간편식 25% (830원 할인, 3,300원 상품)
  - 도시락 20% (660원 할인)
  - 식단관리 20%
  - 아메리카노 30%
  - 달콤디저트 20%
  - 아이스크림 20%

**계산식**:
```
할인액 = Math.floor(정가 × 할인율)
```

### 2. 통신사 할인
- **종류**: 우주패스, SKT, KT알뜰 등
- **적용 방식**: 두 가지 타입
  - **구간 할인**: "1천 원당 300원" 형태
  - **퍼센트 할인**: "20%" 형태
- **중복**: 한 번의 결제에 1개만 사용 가능
- **예외**: KT알뜰은 CU멤버십/네이버플러스와 중복 가능

**계산식 (구간 할인)**:
```
할인_전_금액 = 정가 - 쿠폰할인액
할인액 = Math.floor(할인_전_금액 / 1000) × 할인단위금액
```

**계산식 (퍼센트 할인)**:
```
할인_전_금액 = 정가 - 쿠폰할인액
할인액 = Math.floor(할인_전_금액 × 할인율)
```

**예시**:
- 1천 원당 300원
- 1천 원당 200원
- 1천 원당 100원
- 1천 원당 50원
- 20%
- 10%

### 3. 결제행사 할인
- **종류**: CU 결제행사 (QR코드 제시 필요한 경우 있음)
- **적용 방식**: 금액 할인 또는 퍼센트 할인
- **제약**: 행사가 요구하는 결제수단으로 결제 필요
- **예외**: 일부 행사는 우주패스와 중복 불가, 포켓CU 앱 결제시 통신사/결제행사 할인 불가

**계산식 (금액 할인)**:
```
할인_전_금액 = 정가 - 쿠폰할인액 - 통신사할인액
할인액 = Math.min(할인_전_금액, 할인금액)  // 남은 금액보다 클 수 없음
```

**계산식 (퍼센트 할인)**:
```
할인_전_금액 = 정가 - 쿠폰할인액 - 통신사할인액
할인액 = Math.floor(할인_전_금액 × 할인율)
```

**예시**:
- 500원 할인
- 1000원 할인
- 20%
- 25%
- 30%
- 35%
- 40%
- 45%
- 50%

### 4. 금액권
- **종류**: CU 금액권, 제휴 포인트
- **적용 방식**: 남은 금액에서 차감
- **중복**: 여러 금액권 사용 가능 (복합결제)
- **제약**: 특정 쿠폰과 중복 불가 ([XX카드로 X천원 이상 결제시 X천원 할인] 유형)

**계산식**:
```
할인_전_금액 = 정가 - 쿠폰할인액 - 통신사할인액 - 결제행사할인액
차감액 = Math.min(할인_전_금액, 금액권금액)
```

**예시**:
- CU 1천원권
- 포인트

### 5. 결제 할인(독립형)
- **종류**: 네이버플러스 멤버십, 간편결제, 즉시 할인형 카드
- **적용 방식**: **정가 금액 기준** 퍼센트 할인
- **중복**:
  - 네이버플러스는 네이버페이 등록 카드 할인과 중복 가능
  - 금액권과 중복 **불가**
- **독립형의 의미**: 누적 할인을 무시하고 정가를 기준으로 계산

**계산식**:
```
할인액 = Math.floor(정가 × 할인율)
// 주의: 정가 기준! 누적 할인 금액 기준 아님
```

**예시**:
- 50%
- 40%
- 30%
- 25%
- 20%
- 15%
- 10%
- 5%

### 6. 결제 할인(누적형)
- **종류**: 오키클럽, 청구 할인형 카드
- **적용 방식**: **누적 할인 후 금액 기준** 퍼센트 할인
- **중복**: 금액권과 중복 **가능**
- **누적형의 의미**: 이전 모든 할인이 적용된 후의 금액을 기준으로 계산

**계산식**:
```
할인_전_금액 = 정가 - 쿠폰할인액 - 통신사할인액 - 결제행사할인액 - 금액권차감 - 결제할인(독립형)
할인액 = Math.floor(할인_전_금액 × 할인율)
```

**예시**:
- 30%
- 25%
- 20%
- 15%
- 10%
- 5%

## 🔴 중복 적용 제약사항

### ❌ 중복 불가
1. **동일 색상 셀의 할인방식 간 중복 적용 불가**
   - 같은 카테고리 내에서는 1개만 선택

2. **통신사 할인 / CU 멤버십 / 네이버플러스 멤버십**
   - 서로 중복 적용 불가 (단, KT알뜰은 중복 가능)

3. **금액권 + 결제 할인(독립형)**
   - 중복 적용 불가

4. **키핑, 기프티콘, 상품 교환권**
   - 단독 결제 필요 (다른 할인과 함께 사용 불가)

5. **[XX카드로 X천원 이상 결제시 X천원 할인] 유형의 쿠폰**
   - 단독 결제 필요

6. **포켓CU 앱 결제시**
   - 통신사/결제행사 할인 불가

### ✅ 중복 가능
1. **결제 할인(독립형) + 결제행사 할인**
   - 중복 적용 가능

2. **금액권 + 결제 할인(누적형)**
   - 중복 적용 가능

3. **네이버플러스 멤버십 + 네이버페이 등록 카드 할인**
   - 중복 적용 가능

4. **KT알뜰 + CU멤버십/네이버플러스**
   - 중복 적용 가능

## 📊 실제 계산 예시 (엑셀에서 추출)

### 예시 1: 할인 유형 A
```
정가: 3,300원

1. 쿠폰 할인 (간편식 25%): 830원
   → 남은 금액: 2,470원

2. 통신사 할인 (1천 원당 300원): 900원
   → Math.floor(2,470 / 1,000) × 300 = 600원 (엑셀에서는 900원으로 계산됨 - 정가 기준인 것으로 보임)
   → 남은 금액: 1,570원

3. 결제행사 할인 (1000원 할인): 1,000원
   → 남은 금액: 570원

4. 금액권: 0원

5. 결제 할인(독립형): 0원

6. 결제 할인(누적형): 0원

총 할인액: 2,730원
최종 할인율: 82.73%
최종 결제 금액: 570원
```

### 예시 2: 할인 유형 D
```
정가: 3,300원

1. 쿠폰 할인 (달콤디저트 20%): 660원
   → 남은 금액: 2,640원

2. 통신사 할인: 0원 (X 선택)

3. 결제행사 할인 (40%): 1,320원
   → Math.floor(2,640 × 0.4) = 1,056원 (엑셀에서는 1,320원 - 정가 기준인 것으로 보임)
   → 남은 금액: 1,320원

4. 금액권: 0원

5. 결제 할인(독립형, 25%): 825원
   → Math.floor(3,300 × 0.25) = 825원 (정가 기준!)
   → 남은 금액: 495원

6. 결제 할인(누적형): 0원

총 할인액: 2,805원
최종 할인율: 85%
최종 결제 금액: 495원
```

## 🚨 중요 발견사항

엑셀 분석 결과, **통신사 할인과 결제행사 할인도 정가 기준으로 계산**되는 것으로 보입니다!

### 수정된 할인 적용 순서

```javascript
// 1. 각 할인 유형별로 정가 기준 할인액 계산
const 쿠폰할인액 = Math.floor(정가 × 쿠폰할인율);
const 통신사할인액 = calculate통신사할인(정가, 통신사할인);  // 정가 기준!
const 결제행사할인액 = calculate결제행사할인(정가, 결제행사할인);  // 정가 기준!
const 금액권차감 = Math.min(남은금액, 금액권);
const 독립형할인액 = Math.floor(정가 × 독립형할인율);  // 정가 기준!

// 2. 순차적으로 차감
let 현재금액 = 정가;
현재금액 -= 쿠폰할인액;
현재금액 -= 통신사할인액;
현재금액 -= 결제행사할인액;
현재금액 -= 금액권차감;
현재금액 -= 독립형할인액;

// 3. 누적형 할인만 현재금액 기준
const 누적형할인액 = Math.floor(현재금액 × 누적형할인율);
현재금액 -= 누적형할인액;

최종금액 = 현재금액;
```

## 💡 구현 시 고려사항

1. **정가 기준 할인**이 많으므로, 할인액 계산과 차감을 분리해야 함
2. **금액권**은 남은 금액보다 클 수 없음 (min 처리 필요)
3. **결제 할인(독립형)**과 **금액권**은 중복 불가 → UI에서 제어 필요
4. **통신사 할인**의 "1천 원당 X원" 타입은 정가를 1000으로 나눈 몫으로 계산
5. **반올림 처리**: 모두 `Math.floor()` 사용 (버림)
6. **오차 범위**: 엑셀에 "오차 범위: ± 1원" 표시 있음

## 📱 UI/UX 구현 팁

1. **할인 유형 선택 UI**: 드롭다운 또는 버튼 그룹
2. **실시간 계산 표시**: 각 단계별 할인액과 남은 금액 표시
3. **중복 불가 표시**: 선택한 할인과 중복 불가한 옵션은 비활성화
4. **추천 조합**: 최대 할인 조합 자동 계산 기능
5. **여러 품목 합산**: 장바구니에서 품목별로 다른 할인 적용 후 합산

## 🎁 할인 조합 예시 (엑셀에서 추천)

### 조합 1: 최대 할인
```
구독 쿠폰 n개
+ 우주패스 or KT알뜰
+ 결제행사
+ 오키클럽 or 청구 할인형 카드
```

### 조합 2: 즉시 할인 중심
```
구독 쿠폰 n개
+ 우주패스 or KT알뜰
+ 결제행사
+ 즉시 할인형 카드
```

### 조합 3: 네이버 중심
```
구독 쿠폰 n개
+ KT알뜰
+ 결제행사(네이버페이)
+ 네플 + 즉시 할인형 카드
```

### 조합 4: 금액권 활용
```
구독 쿠폰 n개
+ 우주패스 or KT알뜰
+ 금액권 n개 + 포인트
+ 오키클럽 or 청구 할인형 카드
```

## 📝 추가 정보

- **제작자**: 한스맨
- **첫 배포일**: 2025.04.19
- **현재 버전**: v2.2 (2025.05.11)
- **다음 버전**: v3.0 예정 (26년 중) - 품목별 상세 할인 계산기 도입 예정

---

이 문서는 `CU 할인 계산기_v2.2.xlsx` 파일을 분석하여 작성되었습니다.
